var ejs = require('ejs'),
  utils = require('loader-utils'),
  path = require('path');


module.exports = function (source) {
  this.cacheable && this.cacheable();

  var query = utils.parseQuery(this.query);
  
  var opts = this.options['ejsRenderLoader'] || {};
  if (typeof query.ejs == 'object') {
    for (var key in query.ejs) {
      opts[key] = query.ejs[key];
    }
  }

  // Use filenames relative to working dir, which should be project root
  opts.filename = path.relative(process.cwd(), this.resourcePath);

  var template = ejs.compile(source, opts)(query);

  if (query.raw) return template;

  return 'module.exports = ' + JSON.stringify(template);
};
